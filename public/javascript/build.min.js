jQuery(function(e){e.extend({form:function(t,n,r){if(r==null)r="POST";if(n==null)n={};var i=e("<form>").attr({method:r,action:t}).css({display:"none"});var s=function(t,n){if(e.isArray(n)){for(var r=0;r<n.length;r++){var o=n[r];s(t+"[]",o)}}else if(typeof n==="object"){for(var u in n){if(n.hasOwnProperty(u)){s(t+"["+u+"]",n[u])}}}else if(n!=null){i.append(e("<input>").attr({type:"hidden",name:String(t),value:String(n)}))}};for(var o in n){if(n.hasOwnProperty(o)){s(o,n[o])}}return i.appendTo("body")}})});(function(e){function n(e){var t=[];for(tag in e)t.push(e[tag]);return t}var t=[];window.setGlobalTags=function(e){t=n(e)};e.fn.tagSuggest=function(r){function y(e,t){if(a.delay){if(l.timer)clearTimeout(l.timer);l.timer=setTimeout(function(){S(e,t)},a.delay)}else{S(e,t)}}function b(e){if(e.selectionStart){return e.selectionStart}else if(document.selection){e.focus();var t=document.selection.createRange();if(t==null){return 0}var n=e.createTextRange(),r=n.duplicate();n.moveToBookmark(t.getBookmark());r.setEndPoint("EndToStart",n);return r.text.length}return 0}function w(e,t,n){if(e.setSelectionRange){e.focus();e.setSelectionRange(t,n)}else if(e.createTextRange){var r=e.createTextRange();r.collapse(true);r.moveEnd("character",n);r.moveStart("character",t);r.select()}}function E(e,t){w(e,t,t)}function S(e,t){var n=b(e),r=false,i,s="";var o=n,f;c=[];d="";while(!r){f=e.value.charAt(o);if(f!=" "&&f==f.toUpperCase()){if(/[a-zA-Z0-9]/.test(f))d=f+d;o--}else{r=true}}if(d){for(i=0;i<u.length;i++){if(u[i].indexOf(d)===0){c.push(u[i])}}if(a.sort){c=c.sort(-1)}for(i=0;i<c.length;i++){s+="<"+a.tagWrap+' class="_tag_suggestion">'+c[i].toLowerCase()+"</"+a.tagWrap+">"}g.html(s);p=!!c.length}else{x()}}function x(){g.empty();c=[];p=false}function T(){var e=f.val();if(e==f.attr("title")&&f.is(".hint"))e="";currentTags=e.split(a.separator);x()}function N(e){var t=e.substr(d.length);var n=f.val();var r=b(f[0]);f.val(n.substr(0,r)+t+n.substr(r));E(f[0],r+t.length);T()}function C(e){h=false;var t=e.type;var n=false;switch(e.keyCode){case 37:case 38:case 39:case 40:{x();return true};case 224:case 17:case 16:case 18:{return true};case 8:{if(this.value==""){x();T();return true}else{t="keyup";n=true;y(this)}break};case 9:case 13:{if(p){N(c[0]);h=true;return false}else{return true}};case 27:{x();T();return true};case 32:{T();return true}}if(t=="keyup"){switch(e.charCode){case 9:case 13:{return true}}if(n){T()}y(this,e.charCode)}}var i={matchClass:"editor-tag-matches",innerMatchClass:"editor-tag-matches-inner",tagContainer:"span",tagWrap:"span",sort:true,tags:null,url:null,delay:0,separator:" "};var s,o,u=[],a=e.extend({},i,r);if(a.tags){u=n(a.tags)}else{u=t}var f=e(this);var l=this;var c,h=false;var p=false;var d="";var v={position:0,tag:""};var m=document.createElement(a.tagContainer);var g=document.createElement("div");e(g).addClass(a.innerMatchClass);m.appendChild(g);g=e(g);f.after(m).keypress(C).keyup(C).blur(function(){if(h==true||p){h=false;f.focus()}});m=e(m).click(function(t){if(t.target.nodeName==a.tagWrap.toUpperCase()&&e(t.target).is("._tag_suggestion")){N(t.target.innerHTML)}}).addClass(a.matchClass);T();var o={};o.setTags=function(e){u=n(e)};return o}})(jQuery);(function(e,t){"$:nomunge";var n=e.jQuery||e.Cowboy||(e.Cowboy={}),r;n.throttle=r=function(e,r,i,s){function a(){function l(){u=+(new Date);i.apply(n,f)}function c(){o=t}var n=this,a=+(new Date)-u,f=arguments;if(s&&!o){l()}o&&clearTimeout(o);if(s===t&&a>e){l()}else if(r!==true){o=setTimeout(s?c:l,s===t?e-a:e)}}var o,u=0;if(typeof r!=="boolean"){s=i;i=r;r=t}if(n.guid){a.guid=i.guid=i.guid||n.guid++}return a};n.debounce=function(e,n,i){return i===t?r(e,n,false):r(e,i,n!==false)}})(this);var autocomplete,change=false,title="",characters={},tokens=[];var height;var $editor=$(".editor"),$viewer=$(".viewer"),$download=$(".nav-download"),$viewerScript=$(".viewer-script");$viewerScript.addClass("dpi72").addClass("us-letter");autocomplete=$editor.find("textarea").tagSuggest({tags:characters});var parseStringForArray=function(e){return e.replace(/ *\([^)]*\) */g,"").replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,"")};var removeParentheticals=function(e){return e.replace(/ *\([^)]*\) */g,"")};var resize=function(){height=$(window).innerHeight();$viewer.height(height);$editor.height(height)};var dragOver=function(e){$(this).addClass("over");e.stopPropagation();e.preventDefault()};var dragLeave=function(e){$(this).removeClass("over");e.stopPropagation();e.preventDefault()};var loadScript=function(e){e.preventDefault();e.stopPropagation();e=e.originalEvent;$(this).removeClass("over");var t=e.dataTransfer.files[0],n=new FileReader;if(t){n.onload=function(e){$editor.find("textarea").val(e.target.result);change=true};n.readAsText(t)}};var page=function(e,t){var n=$(document.createElement("div")).addClass("viewer-script-page").html(e);if(t){n.addClass("title-page")}else{n.children("div.dialogue.dual").each(function(){dual=$(this).prev("div.dialogue");$(this).wrap($(document.createElement("div")).addClass("dual-dialogue"));dual.prependTo($(this).parent())})}return n};var backgroundFunctions=function(){fountain.parse($editor.find("textarea").val(),true,function(e){if(e){tokens=e;$viewerScript.html("");if(e.title&&e.html.title_page){$viewerScript.append(page(e.html.title_page,true));title=e.title||"Untitled"}$viewerScript.append(page(e.html.script));for(i in e.tokens){if(e.tokens[i].type=="character"){var t=parseStringForArray(e.tokens[i]["text"]);if(!characters[t]){characters[t]=removeParentheticals(e.tokens[i]["text"])}}}autocomplete.setTags(characters)}})};$editor.find("textarea").on("change keyup",$.debounce(250,backgroundFunctions));$editor.on("dragleave",dragLeave).on("dragover",dragOver).on("drop",loadScript);$download.on("click",function(){$.form("/download",{type:"fdx",filename:title,tokens:JSON.stringify(tokens),content:$editor.find("textarea").val()}).submit()});if(window.File&&window.FileReader&&window.FileList&&window.Blob){}else{alert("The File APIs are not fully supported in this browser.")}$(window).resize(resize);resize();setInterval(backgroundFunctions,3e3)